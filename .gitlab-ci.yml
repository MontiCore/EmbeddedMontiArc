stages:
- build
- test
 
windows_build:
  stage: build
  script: 
  - call VsDevCmd.bat
  - call docs\build_release.bat
  tags:
  - Windows10
  artifacts:
    paths:
      - hardware_emulator/build/Release/hardware-emulator-test.exe
      - hardware_emulator/build/Release/HardwareEmulator.dll

test_windows:
  stage: test
  tags:
  - Windows10
  script:
    - copy "hardware_emulator\build\Debug\hardware-emulator-test.exe" "hardware_emulator\bin"
    - cd hardware_emulator\bin
    - hardware-emulator-test
  dependencies:
    - windows_build

linux_build:
  stage: build
  image: maven:3-jdk-8

  script:
  - apt update
  - apt --assume-yes install make
  - apt --assume-yes install python
  - apt --assume-yes install g++
  - apt --assume-yes install cmake
  - g++ --version
  
  - cd unicorn
  - ./make.sh
  - cd ..
  
  - cd zydis
  - cd dependencies/zycore
  - mkdir build
  - cd build
  - cmake -G "Unix Makefiles" ../
  - make
  - cd ../../..
  - mkdir build
  - cd build
  - cmake -G "Unix Makefiles" ../
  - make
  - cd ..
  - cd ..
  
  - cd pe-parse
  - mkdir Release
  - cd Release
  - cmake -DCMAKE_BUILD_TYPE=Release -G "Unix Makefiles" ../
  - make
  - cd ..
  - cd ..
  
  - cd hardware_emulator
  - mkdir Release
  - cd Release
  - cmake -DCMAKE_BUILD_TYPE=Release -G "Unix Makefiles" ../
  - make
  - cd ..
  - cd ..
  artifacts:
    paths:
      - hardware_emulator/Release/hardware-emulator-test
      - hardware_emulator/Release/libHardwareEmulator.so

test_linux:
  stage: test
  image: maven:3-jdk-8
  script:
    - mv hardware_emulator/Release/hardware-emulator-test hardware_emulator/bin/hardware-emulator-test
    - cd hardware_emulator/bin
    - ./hardware-emulator-test
  dependencies:
    - linux_build