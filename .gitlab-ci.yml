stages:
- build
- test
 
windows_build:
  stage: build
  script: 
  - call VsDevCmd.bat
  - call docs\build_all_msvc.bat
  tags:
  - Windows10
  artifacts:
    paths:
      - hardware_emulator/build/Debug/hardware-emulator-test.exe
      - hardware_emulator/bin/AutopilotModel.dll
      - hardware_emulator/bin/loaded_dll.dll
      - hardware_emulator/bin/SampleDLL.dll

test_windows:
  stage: test
  tags:
  - Windows10
  script:
    - copy "hardware_emulator\build\Debug\hardware-emulator-test.exe" "hardware_emulator\bin"
    - cd hardware_emulator\bin
    - hardware-emulator-test
  dependencies:
    - windows_build

linux_build:
  stage: build
  image: maven:3-jdk-8

  script:
  - apt update
  - apt install g++-7 -y
  - update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-7 60 --slave /usr/bin/gcc-ar gcc-ar /usr/bin/gcc-ar-7 --slave /usr/bin/gcc-nm gcc-nm /usr/bin/gcc-nm-7 --slave /usr/bin/gcc-ranlib gcc-ranlib /usr/bin/gcc-ranlib-7
  
  - apt --assume-yes install make
  - apt --assume-yes install python
  - apt --assume-yes install cmake
  - g++ --version
  
  - cd unicorn
  - ./make.sh
  - cd ..
  
  - cd zydis
  - cd dependencies/zycore
  - mkdir build
  - cd build
  - cmake -G "Unix Makefiles" ../
  - make
  - cd ../../..
  - mkdir build
  - cd build
  - cmake -G "Unix Makefiles" ../
  - make
  - cmake -G "Unix Makefiles" -DZYDIS_BUILD_SHARED_LIB=ON ../
  - make
  - cd ..
  - cd ..
  
  - cd pe-parse
  - mkdir Release
  - cd Release
  - cmake -DCMAKE_BUILD_TYPE=Release -G "Unix Makefiles" ../
  - make
  - cd ..
  - mkdir Debug
  - cd Debug
  - cmake -DCMAKE_BUILD_TYPE=Debug -G "Unix Makefiles" ../
  - make
  - cd ..
  - cd ..
  
  - cd hardware_emulator
  - mkdir Release
  - cd Release
  - cmake -DCMAKE_BUILD_TYPE=Release -G "Unix Makefiles" ../
  - make
  - cd ..
  - mkdir Debug
  - cd Debug
  - cmake -DCMAKE_BUILD_TYPE=Debug -G "Unix Makefiles" ../
  - make
  - cd ..
  - cd ..
  artifacts:
    paths:
      - hardware_emulator/build/hardware-emulator-test

#test_linux:
#  stage: test
#  tags:
#  - linux
#  script:
#    - mv hardware_emulator/build/hardware-emulator-test hardware_emulator/bin/hardware-emulator-test
#    - cd hardware_emulator/bin
#    - hardware-emulator-test
#  dependencies:
#    - linux_build