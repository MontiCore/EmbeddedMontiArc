# (c) https://github.com/MontiCore/monticore
#
image: maven:3-jdk-8


githubjob:
  before_script:
  - 'which ssh-agent || ( apt-get update -y && apt-get install openssh-client -y )'
  - eval $(ssh-agent -s)
  - ssh-add <(echo "$GITHUB_SSH_PRIV_KEY2" | base64 -d)
  - git config --global user.email "kusmenko@se-rwth.de"
  - git config --global user.name "EMA CI"
  - mkdir -p ~/.ssh
  - cat gitlab-known-hosts >> ~/.ssh/known_hosts
  script: 
  - git clone https://github.com/MontiCore/EmbeddedMontiArc.git
  - cd EmbeddedMontiArc
  - git subtree pull --prefix languages/EmbeddedMontiArc https://git.rwth-aachen.de/monticore/EmbeddedMontiArc/languages/EmbeddedMontiArc.git master
  - git push --force
  only:
  - master


masterJob:
  script: 
  - mvn -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn -B  clean deploy sonar:sonar --settings settings.xml
  # do not call mvn twice -> this run all tests twice -> needs much resources and blocks the gitlab runner
  only:
  - master
  except:
    changes:
    - .gitlab-ci.yml
    - README.md
  
BranchJob:
  script: 
  - mvn -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn -B  clean install --settings settings.xml
  except:
    - master

