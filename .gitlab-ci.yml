stages:
- linuxBuildJava17
- linuxBuildJava1_8
- linuxTrain

TestBuildJava17:
  stage: linuxBuildJava17
  image: maven:3.8.3-openjdk-17
  artifacts:
    paths:
      - "tictactoe-environment/target/"
    expire_in: 1 week
  script:
    - cd tictactoe-environment
    - mvn clean package -s settings.xml

TestBuildJava1_8:
  stage: linuxBuildJava1_8
  image: registry.git.rwth-aachen.de/monticore/embeddedmontiarc/applications/reinforcement_learning/cartpole/rl-fix-new2:latest
  dependencies:
    - TestBuildJava17
  before_script:
    - apt-get update
    - apt-get install -y maven 
  artifacts:
    paths:
      - "tictactoe-agent/generator-target/"
    expire_in: 1 week
  script:
    - cd ../tictactoe-agent
    - chmod 777 *.sh
    - ./install.sh
  
TestTrain:
  stage: linuxTrain
  image: registry.git.rwth-aachen.de/monticore/embeddedmontiarc/applications/reinforcement_learning/cartpole/rl-fix-new2:latest
  dependencies:
    - TestBuildJava17
    - TestBuildJava1_8

  before_script:
      - apt-get update
      - apt-get install -y maven
      - apt-get install -y gnupg2
      - echo "deb http://ppa.launchpad.net/swi-prolog/stable/ubuntu $(cat /etc/os-release | grep -oP -m 1 "VERSION_CODENAME=\K\w+") main" | tee -a /etc/apt/sources.list
      - echo "deb-src http://ppa.launchpad.net/swi-prolog/stable/ubuntu $(cat /etc/os-release | grep -oP -m 1 "VERSION_CODENAME=\K\w+") main" | tee -a /etc/apt/sources.list
      - apt-key adv --keyserver keyserver.ubuntu.com --recv-keys EF8406856DBFCA18
      - apt-get update
      - apt-get install -y swi-prolog

  script:
      - cd tictactoe-environment
      - ls -la
      - roscore &
      - sleep 2
      - java -cp "target/tictactoe-environment-1.0-SNAPSHOT.jar" de.gdl.rl.environment.games.tictactoe.TicTacToeEnv --training &
      - echo "waiting 15 ..."
      - sleep 15