/* (c) https://github.com/MontiCore/monticore */
/* generated from model null*/
/* generated by template symboltable.SymbolReference*/

package de.monticore.lang.embeddedmontiarc.embeddedmontiarc._symboltable.cncModel;

import com.google.common.collect.ImmutableList;
import de.monticore.expressionsbasis._ast.ASTExpression;
import de.monticore.lang.embeddedmontiarc.embeddedmontiarc._ast.ASTPortInitialValueOrGuess;
import de.monticore.lang.embeddedmontiarc.embeddedmontiarc._symboltable.EmbeddedMontiArcSymbolTableCreator;
import de.monticore.lang.monticar.si._symboltable.ResolutionDeclarationSymbol;
import de.monticore.symboltable.MutableScope;
import de.monticore.symboltable.Scope;
import de.monticore.symboltable.modifiers.AccessModifier;
import de.monticore.symboltable.references.CommonSymbolReference;
import de.monticore.symboltable.references.SymbolReference;
import de.monticore.symboltable.types.references.ActualTypeArgument;
import de.se_rwth.commons.logging.Log;

import java.util.ArrayList;
import java.util.List;
import java.util.Optional;

/**
 * Represents a reference of {@link EMAComponentSymbol}.
 */
public class EMAComponentSymbolReference extends EMAComponentSymbol implements
        SymbolReference<EMAComponentSymbol> {

    protected final SymbolReference<EMAComponentSymbol> reference;
    private List<ActualTypeArgument> actualTypeArguments = new ArrayList<>();

    private List<ResolutionDeclarationSymbol> resSymbols = new ArrayList<>();
    private List<ASTExpression> arguments = new ArrayList<>();
    private List<ASTPortInitialValueOrGuess> initalGuesses = new ArrayList<>();

    public EMAComponentSymbolReference(final String name, final Scope definingScopeOfReference) {
        super(name);
        reference = new CommonSymbolReference<>(name, EMAComponentSymbol.KIND, definingScopeOfReference);
        if (existsReferencedSymbol()) {
            setReferencedComponent(Optional.of(getReferencedSymbol()));

        }

    }


    public EMAComponentSymbolReference(final String name, final Scope definingScopeOfReference, EmbeddedMontiArcSymbolTableCreator emastc) {
        super(name);
        reference = new CommonSymbolReference<>(name, EMAComponentSymbol.KIND, definingScopeOfReference);
        if (existsReferencedSymbol()) {
            Log.debug("Loading resolution declarationSymbols", "info");
            setReferencedComponent(Optional.of(getReferencedSymbol()));
            resSymbols.addAll(reference.getReferencedSymbol().getResolutionDeclarationSymbols());

        } else {
            Log.debug("Reference to " + name + " does not exist", "info");

        }

    }


    public List<ResolutionDeclarationSymbol> getResDeclSyms() {
        return resSymbols;
    }

    @Override
    public List<ResolutionDeclarationSymbol> getResolutionDeclarationSymbols() {
        return resSymbols;
    }

    @Override
    public Optional<ResolutionDeclarationSymbol> getResolutionDeclarationSymbol(String name) {
        for (ResolutionDeclarationSymbol symbol : getResolutionDeclarationSymbols()) {
            if (symbol.getNameToResolve().equals(name))
                return Optional.of(symbol);
        }
        return Optional.empty();
    }

    @Override
    public boolean hasResolutionDeclaration(String name) {
        for (ResolutionDeclarationSymbol resDeclSym : resSymbols)
            if (resDeclSym.getNameToResolve().equals(name)) {
                return true;
            }
        return false;
    }

    @Override
    public int howManyResolutionDeclarationSymbol() {
        return resSymbols.size();
    }

    public void fixResolutions(EmbeddedMontiArcSymbolTableCreator emastc) {

        int count = 0;
        for (ResolutionDeclarationSymbol resDeclSym : getResolutionDeclarationSymbols()) {
            //Log.debug("" + ((ASTUnitNumberResolution) getResolutionDeclarationSymbols().get(count).getASTResolution()).getNumber().get().intValue(), "resolus:");
            String lastNameStart = "";
            for (EMAPortSymbol emaPortSymbol : getPortsList()) {
                Log.debug(emaPortSymbol.getName(), "Found Port:");
                if (!emaPortSymbol.getNameWithoutArrayBracketPart().equals(lastNameStart)) {
                    lastNameStart = emaPortSymbol.getNameWithoutArrayBracketPart();
                    Log.debug(lastNameStart, "Found PortArray:");
                    Log.debug(emaPortSymbol.getEnclosingScope().toString(), "PortArray enclosing scope:");
                    EMAPortArraySymbol emaPortArraySymbol = emaPortSymbol.getEnclosingScope().<EMAPortArraySymbol>resolve(lastNameStart, EMAPortArraySymbol.KIND).get();
                    emaPortArraySymbol.recreatePortArray(resDeclSym, emastc, this);
                }
            }
        }

        Log.debug("" + getIncomingPorts().size(), "incoming:");

        Log.debug("" + getOutgoingPorts().size(), "outgoing:");
    }

    public List<ActualTypeArgument> getActualTypeArguments() {
        return ImmutableList.copyOf(actualTypeArguments);
    }

    public void setActualTypeArguments(List<ActualTypeArgument> actualTypeArguments) {
        this.actualTypeArguments = new ArrayList<>(actualTypeArguments);
    }

    public boolean hasActualTypeArguments() {
        return this.actualTypeArguments.size() > 0;
    }

    // no overridden methods of EMAComponentSymbol as the EMAComponentSymbol itself checks whether it is a
    // reference or not.
  
  /* Methods of SymbolReference interface */

    @Override
    public EMAComponentSymbol getReferencedSymbol() {
        return reference.getReferencedSymbol();
    }

    @Override
    public boolean existsReferencedSymbol() {
        return reference.existsReferencedSymbol();
    }

    @Override
    public boolean isReferencedSymbolLoaded() {
        return reference.isReferencedSymbolLoaded();
    }

    @Override
    public List<ASTExpression> getArguments() {
        return arguments;
    }

    @Override
    public void addArgument(ASTExpression astExpression) {
        arguments.add(astExpression);
    }

    @Override
    public void setArguments(List<ASTExpression> arguments) {
        this.arguments = arguments;
    }

    @Override
    public List<ASTPortInitialValueOrGuess> getInitalGuesses() {
        return this.initalGuesses;
    }

    @Override
    public void addInitialGuess(ASTPortInitialValueOrGuess initialGuess) {
        this.initalGuesses.add(initialGuess);
    }

    @Override
    public void setInitialGuesses(List<ASTPortInitialValueOrGuess> initalGuesses) {
        this.initalGuesses = initalGuesses;
    }

    /* Methods of Symbol interface */

    @Override
    public String getName() {
        return getReferencedSymbol().getName();
    }

    @Override
    public String getFullName() {
        return getReferencedSymbol().getFullName();
    }

    @Override
    public Scope getEnclosingScope() {
        return getReferencedSymbol().getEnclosingScope();
    }

    @Override
    public void setEnclosingScope(MutableScope scope) {
        getReferencedSymbol().setEnclosingScope(scope);
    }

    @Override
    public AccessModifier getAccessModifier() {
        return getReferencedSymbol().getAccessModifier();
    }

    @Override
    public void setAccessModifier(AccessModifier accessModifier) {
        getReferencedSymbol().setAccessModifier(accessModifier);
    }
}
