/**
 * ====
 *     ====
 *         ====
 *             ====
 *                 ====
 *                     ====
 *                         ====
 *                             ====
 *                                 ====
 *                                     ====
 *                                         ====
 *                                             ====
 *                                                 ====
 *                                                     ====
 *                                                         ====
 *                                                             ====
 *                                                                 ====
 *                                                                     ====
 *                                                                         ====
 *                                                                             ******************************************************************************
 *                                                                              MontiCAR Modeling Family, www.se-rwth.de
 *                                                                              Copyright (c) 2017, Software Engineering Group at RWTH Aachen,
 *                                                                              All rights reserved.
 *
 *                                                                              This project is free software; you can redistribute it and/or
 *                                                                              modify it under the terms of the GNU Lesser General Public
 *                                                                              License as published by the Free Software Foundation; either
 *                                                                              version 3.0 of the License, or (at your option) any later version.
 *                                                                              This library is distributed in the hope that it will be useful,
 *                                                                              but WITHOUT ANY WARRANTY; without even the implied warranty of
 *                                                                              MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
 *                                                                              Lesser General Public License for more details.
 *
 *                                                                              You should have received a copy of the GNU Lesser General Public
 *                                                                              License along with this project. If not, see <http://www.gnu.org/licenses/>.
 *                                                                             *******************************************************************************
 *                                                                         ====
 *
 *                                                                         ******************************************************************************
 *                                                                          MontiCAR Modeling Family, www.se-rwth.de
 *                                                                          Copyright (c) 2017, Software Engineering Group at RWTH Aachen,
 *                                                                          All rights reserved.
 *
 *                                                                          This project is free software; you can redistribute it and/or
 *                                                                          modify it under the terms of the GNU Lesser General Public
 *                                                                          License as published by the Free Software Foundation; either
 *                                                                          version 3.0 of the License, or (at your option) any later version.
 *                                                                          This library is distributed in the hope that it will be useful,
 *                                                                          but WITHOUT ANY WARRANTY; without even the implied warranty of
 *                                                                          MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
 *                                                                          Lesser General Public License for more details.
 *
 *                                                                          You should have received a copy of the GNU Lesser General Public
 *                                                                          License along with this project. If not, see <http://www.gnu.org/licenses/>.
 *                                                                         *******************************************************************************
 *                                                                     ====
 *
 *                                                                     ******************************************************************************
 *                                                                      MontiCAR Modeling Family, www.se-rwth.de
 *                                                                      Copyright (c) 2017, Software Engineering Group at RWTH Aachen,
 *                                                                      All rights reserved.
 *
 *                                                                      This project is free software; you can redistribute it and/or
 *                                                                      modify it under the terms of the GNU Lesser General Public
 *                                                                      License as published by the Free Software Foundation; either
 *                                                                      version 3.0 of the License, or (at your option) any later version.
 *                                                                      This library is distributed in the hope that it will be useful,
 *                                                                      but WITHOUT ANY WARRANTY; without even the implied warranty of
 *                                                                      MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
 *                                                                      Lesser General Public License for more details.
 *
 *                                                                      You should have received a copy of the GNU Lesser General Public
 *                                                                      License along with this project. If not, see <http://www.gnu.org/licenses/>.
 *                                                                     *******************************************************************************
 *                                                                 ====
 *
 *                                                                 ******************************************************************************
 *                                                                  MontiCAR Modeling Family, www.se-rwth.de
 *                                                                  Copyright (c) 2017, Software Engineering Group at RWTH Aachen,
 *                                                                  All rights reserved.
 *
 *                                                                  This project is free software; you can redistribute it and/or
 *                                                                  modify it under the terms of the GNU Lesser General Public
 *                                                                  License as published by the Free Software Foundation; either
 *                                                                  version 3.0 of the License, or (at your option) any later version.
 *                                                                  This library is distributed in the hope that it will be useful,
 *                                                                  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *                                                                  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
 *                                                                  Lesser General Public License for more details.
 *
 *                                                                  You should have received a copy of the GNU Lesser General Public
 *                                                                  License along with this project. If not, see <http://www.gnu.org/licenses/>.
 *                                                                 *******************************************************************************
 *                                                             ====
 *
 *                                                             ******************************************************************************
 *                                                              MontiCAR Modeling Family, www.se-rwth.de
 *                                                              Copyright (c) 2017, Software Engineering Group at RWTH Aachen,
 *                                                              All rights reserved.
 *
 *                                                              This project is free software; you can redistribute it and/or
 *                                                              modify it under the terms of the GNU Lesser General Public
 *                                                              License as published by the Free Software Foundation; either
 *                                                              version 3.0 of the License, or (at your option) any later version.
 *                                                              This library is distributed in the hope that it will be useful,
 *                                                              but WITHOUT ANY WARRANTY; without even the implied warranty of
 *                                                              MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
 *                                                              Lesser General Public License for more details.
 *
 *                                                              You should have received a copy of the GNU Lesser General Public
 *                                                              License along with this project. If not, see <http://www.gnu.org/licenses/>.
 *                                                             *******************************************************************************
 *                                                         ====
 *
 *                                                         ******************************************************************************
 *                                                          MontiCAR Modeling Family, www.se-rwth.de
 *                                                          Copyright (c) 2017, Software Engineering Group at RWTH Aachen,
 *                                                          All rights reserved.
 *
 *                                                          This project is free software; you can redistribute it and/or
 *                                                          modify it under the terms of the GNU Lesser General Public
 *                                                          License as published by the Free Software Foundation; either
 *                                                          version 3.0 of the License, or (at your option) any later version.
 *                                                          This library is distributed in the hope that it will be useful,
 *                                                          but WITHOUT ANY WARRANTY; without even the implied warranty of
 *                                                          MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
 *                                                          Lesser General Public License for more details.
 *
 *                                                          You should have received a copy of the GNU Lesser General Public
 *                                                          License along with this project. If not, see <http://www.gnu.org/licenses/>.
 *                                                         *******************************************************************************
 *                                                     ====
 *
 *                                                     ******************************************************************************
 *                                                      MontiCAR Modeling Family, www.se-rwth.de
 *                                                      Copyright (c) 2017, Software Engineering Group at RWTH Aachen,
 *                                                      All rights reserved.
 *
 *                                                      This project is free software; you can redistribute it and/or
 *                                                      modify it under the terms of the GNU Lesser General Public
 *                                                      License as published by the Free Software Foundation; either
 *                                                      version 3.0 of the License, or (at your option) any later version.
 *                                                      This library is distributed in the hope that it will be useful,
 *                                                      but WITHOUT ANY WARRANTY; without even the implied warranty of
 *                                                      MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
 *                                                      Lesser General Public License for more details.
 *
 *                                                      You should have received a copy of the GNU Lesser General Public
 *                                                      License along with this project. If not, see <http://www.gnu.org/licenses/>.
 *                                                     *******************************************************************************
 *                                                 ====
 *
 *                                                 ******************************************************************************
 *                                                  MontiCAR Modeling Family, www.se-rwth.de
 *                                                  Copyright (c) 2017, Software Engineering Group at RWTH Aachen,
 *                                                  All rights reserved.
 *
 *                                                  This project is free software; you can redistribute it and/or
 *                                                  modify it under the terms of the GNU Lesser General Public
 *                                                  License as published by the Free Software Foundation; either
 *                                                  version 3.0 of the License, or (at your option) any later version.
 *                                                  This library is distributed in the hope that it will be useful,
 *                                                  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *                                                  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
 *                                                  Lesser General Public License for more details.
 *
 *                                                  You should have received a copy of the GNU Lesser General Public
 *                                                  License along with this project. If not, see <http://www.gnu.org/licenses/>.
 *                                                 *******************************************************************************
 *                                             ====
 *
 *                                             ******************************************************************************
 *                                              MontiCAR Modeling Family, www.se-rwth.de
 *                                              Copyright (c) 2017, Software Engineering Group at RWTH Aachen,
 *                                              All rights reserved.
 *
 *                                              This project is free software; you can redistribute it and/or
 *                                              modify it under the terms of the GNU Lesser General Public
 *                                              License as published by the Free Software Foundation; either
 *                                              version 3.0 of the License, or (at your option) any later version.
 *                                              This library is distributed in the hope that it will be useful,
 *                                              but WITHOUT ANY WARRANTY; without even the implied warranty of
 *                                              MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
 *                                              Lesser General Public License for more details.
 *
 *                                              You should have received a copy of the GNU Lesser General Public
 *                                              License along with this project. If not, see <http://www.gnu.org/licenses/>.
 *                                             *******************************************************************************
 *                                         ====
 *
 *                                         ******************************************************************************
 *                                          MontiCAR Modeling Family, www.se-rwth.de
 *                                          Copyright (c) 2017, Software Engineering Group at RWTH Aachen,
 *                                          All rights reserved.
 *
 *                                          This project is free software; you can redistribute it and/or
 *                                          modify it under the terms of the GNU Lesser General Public
 *                                          License as published by the Free Software Foundation; either
 *                                          version 3.0 of the License, or (at your option) any later version.
 *                                          This library is distributed in the hope that it will be useful,
 *                                          but WITHOUT ANY WARRANTY; without even the implied warranty of
 *                                          MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
 *                                          Lesser General Public License for more details.
 *
 *                                          You should have received a copy of the GNU Lesser General Public
 *                                          License along with this project. If not, see <http://www.gnu.org/licenses/>.
 *                                         *******************************************************************************
 *                                     ====
 *
 *                                     ******************************************************************************
 *                                      MontiCAR Modeling Family, www.se-rwth.de
 *                                      Copyright (c) 2017, Software Engineering Group at RWTH Aachen,
 *                                      All rights reserved.
 *
 *                                      This project is free software; you can redistribute it and/or
 *                                      modify it under the terms of the GNU Lesser General Public
 *                                      License as published by the Free Software Foundation; either
 *                                      version 3.0 of the License, or (at your option) any later version.
 *                                      This library is distributed in the hope that it will be useful,
 *                                      but WITHOUT ANY WARRANTY; without even the implied warranty of
 *                                      MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
 *                                      Lesser General Public License for more details.
 *
 *                                      You should have received a copy of the GNU Lesser General Public
 *                                      License along with this project. If not, see <http://www.gnu.org/licenses/>.
 *                                     *******************************************************************************
 *                                 ====
 *
 *                                 ******************************************************************************
 *                                  MontiCAR Modeling Family, www.se-rwth.de
 *                                  Copyright (c) 2017, Software Engineering Group at RWTH Aachen,
 *                                  All rights reserved.
 *
 *                                  This project is free software; you can redistribute it and/or
 *                                  modify it under the terms of the GNU Lesser General Public
 *                                  License as published by the Free Software Foundation; either
 *                                  version 3.0 of the License, or (at your option) any later version.
 *                                  This library is distributed in the hope that it will be useful,
 *                                  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *                                  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
 *                                  Lesser General Public License for more details.
 *
 *                                  You should have received a copy of the GNU Lesser General Public
 *                                  License along with this project. If not, see <http://www.gnu.org/licenses/>.
 *                                 *******************************************************************************
 *                             ====
 *
 *                             ******************************************************************************
 *                              MontiCAR Modeling Family, www.se-rwth.de
 *                              Copyright (c) 2017, Software Engineering Group at RWTH Aachen,
 *                              All rights reserved.
 *
 *                              This project is free software; you can redistribute it and/or
 *                              modify it under the terms of the GNU Lesser General Public
 *                              License as published by the Free Software Foundation; either
 *                              version 3.0 of the License, or (at your option) any later version.
 *                              This library is distributed in the hope that it will be useful,
 *                              but WITHOUT ANY WARRANTY; without even the implied warranty of
 *                              MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
 *                              Lesser General Public License for more details.
 *
 *                              You should have received a copy of the GNU Lesser General Public
 *                              License along with this project. If not, see <http://www.gnu.org/licenses/>.
 *                             *******************************************************************************
 *                         ====
 *
 *                         ******************************************************************************
 *                          MontiCAR Modeling Family, www.se-rwth.de
 *                          Copyright (c) 2017, Software Engineering Group at RWTH Aachen,
 *                          All rights reserved.
 *
 *                          This project is free software; you can redistribute it and/or
 *                          modify it under the terms of the GNU Lesser General Public
 *                          License as published by the Free Software Foundation; either
 *                          version 3.0 of the License, or (at your option) any later version.
 *                          This library is distributed in the hope that it will be useful,
 *                          but WITHOUT ANY WARRANTY; without even the implied warranty of
 *                          MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
 *                          Lesser General Public License for more details.
 *
 *                          You should have received a copy of the GNU Lesser General Public
 *                          License along with this project. If not, see <http://www.gnu.org/licenses/>.
 *                         *******************************************************************************
 *                     ====
 *
 *                     ******************************************************************************
 *                      MontiCAR Modeling Family, www.se-rwth.de
 *                      Copyright (c) 2017, Software Engineering Group at RWTH Aachen,
 *                      All rights reserved.
 *
 *                      This project is free software; you can redistribute it and/or
 *                      modify it under the terms of the GNU Lesser General Public
 *                      License as published by the Free Software Foundation; either
 *                      version 3.0 of the License, or (at your option) any later version.
 *                      This library is distributed in the hope that it will be useful,
 *                      but WITHOUT ANY WARRANTY; without even the implied warranty of
 *                      MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
 *                      Lesser General Public License for more details.
 *
 *                      You should have received a copy of the GNU Lesser General Public
 *                      License along with this project. If not, see <http://www.gnu.org/licenses/>.
 *                     *******************************************************************************
 *                 ====
 *
 *                 ******************************************************************************
 *                  MontiCAR Modeling Family, www.se-rwth.de
 *                  Copyright (c) 2017, Software Engineering Group at RWTH Aachen,
 *                  All rights reserved.
 *
 *                  This project is free software; you can redistribute it and/or
 *                  modify it under the terms of the GNU Lesser General Public
 *                  License as published by the Free Software Foundation; either
 *                  version 3.0 of the License, or (at your option) any later version.
 *                  This library is distributed in the hope that it will be useful,
 *                  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *                  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
 *                  Lesser General Public License for more details.
 *
 *                  You should have received a copy of the GNU Lesser General Public
 *                  License along with this project. If not, see <http://www.gnu.org/licenses/>.
 *                 *******************************************************************************
 *             ====
 *
 *             ******************************************************************************
 *              MontiCAR Modeling Family, www.se-rwth.de
 *              Copyright (c) 2017, Software Engineering Group at RWTH Aachen,
 *              All rights reserved.
 *
 *              This project is free software; you can redistribute it and/or
 *              modify it under the terms of the GNU Lesser General Public
 *              License as published by the Free Software Foundation; either
 *              version 3.0 of the License, or (at your option) any later version.
 *              This library is distributed in the hope that it will be useful,
 *              but WITHOUT ANY WARRANTY; without even the implied warranty of
 *              MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
 *              Lesser General Public License for more details.
 *
 *              You should have received a copy of the GNU Lesser General Public
 *              License along with this project. If not, see <http://www.gnu.org/licenses/>.
 *             *******************************************************************************
 *         ====
 *
 *         ******************************************************************************
 *          MontiCAR Modeling Family, www.se-rwth.de
 *          Copyright (c) 2017, Software Engineering Group at RWTH Aachen,
 *          All rights reserved.
 *
 *          This project is free software; you can redistribute it and/or
 *          modify it under the terms of the GNU Lesser General Public
 *          License as published by the Free Software Foundation; either
 *          version 3.0 of the License, or (at your option) any later version.
 *          This library is distributed in the hope that it will be useful,
 *          but WITHOUT ANY WARRANTY; without even the implied warranty of
 *          MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
 *          Lesser General Public License for more details.
 *
 *          You should have received a copy of the GNU Lesser General Public
 *          License along with this project. If not, see <http://www.gnu.org/licenses/>.
 *         *******************************************************************************
 *     ====
 *
 *     ******************************************************************************
 *      MontiCAR Modeling Family, www.se-rwth.de
 *      Copyright (c) 2017, Software Engineering Group at RWTH Aachen,
 *      All rights reserved.
 *
 *      This project is free software; you can redistribute it and/or
 *      modify it under the terms of the GNU Lesser General Public
 *      License as published by the Free Software Foundation; either
 *      version 3.0 of the License, or (at your option) any later version.
 *      This library is distributed in the hope that it will be useful,
 *      but WITHOUT ANY WARRANTY; without even the implied warranty of
 *      MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
 *      Lesser General Public License for more details.
 *
 *      You should have received a copy of the GNU Lesser General Public
 *      License along with this project. If not, see <http://www.gnu.org/licenses/>.
 *     *******************************************************************************
 * ====
 *
 * ******************************************************************************
 *  MontiCAR Modeling Family, www.se-rwth.de
 *  Copyright (c) 2017, Software Engineering Group at RWTH Aachen,
 *  All rights reserved.
 *
 *  This project is free software; you can redistribute it and/or
 *  modify it under the terms of the GNU Lesser General Public
 *  License as published by the Free Software Foundation; either
 *  version 3.0 of the License, or (at your option) any later version.
 *  This library is distributed in the hope that it will be useful,
 *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
 *  Lesser General Public License for more details.
 *
 *  You should have received a copy of the GNU Lesser General Public
 *  License along with this project. If not, see <http://www.gnu.org/licenses/>.
 * *******************************************************************************
 */
package simulation.vehicle;

import com.google.gson.Gson;
import commons.controller.interfaces.Bus;
import commons.controller.interfaces.FunctionBlockInterface;
import commons.simulation.PhysicalObjectType;
import org.apache.commons.math3.geometry.euclidean.threed.Rotation;
import org.apache.commons.math3.geometry.euclidean.threed.RotationConvention;
import org.apache.commons.math3.geometry.euclidean.threed.RotationOrder;
import org.apache.commons.math3.linear.ArrayRealVector;
import org.apache.commons.math3.linear.BlockRealMatrix;
import org.apache.commons.math3.linear.RealMatrix;
import simulation.util.Log;

import java.io.*;
import java.nio.file.Files;
import java.util.ArrayList;
import java.util.Optional;

/**
 * Builder class for a physicalVehicle to avoid complex physicalVehicle constructors
 */
public class PhysicalVehicleBuilder {

    /** Singleton instance of the class */
    private static PhysicalVehicleBuilder instance = null;

    /** The vehicle created by this class*/
    private PhysicalVehicle physicalVehicle = new MassPointPhysicalVehicle();

    /**
     * Empty constructor, this is a singleton class
     */
    private PhysicalVehicleBuilder() {
    }

    /**
     * Function that creates or gets an instance of PhysicalVehicleBuilder
     *
     * @return PhysicalVehicleBuilder singleton class
     */
    public static PhysicalVehicleBuilder getInstance() {
        if (instance == null) {
            instance = new PhysicalVehicleBuilder();
        }

        return instance;
    }

    /**
     * Function that resets the instance of PhysicalVehicleBuilder
     */
    public static void resetInstance() {
        instance = null;
    }

    /**
     * Function that resets the physicalVehicle that is currently built in the builder class
     * Changes values to the default physicalVehicle values
     *
     * @return PhysicalVehicleBuilder singleton class
     */
    private PhysicalVehicleBuilder resetPhysicalVehicle() {
        Log.finest("PhysicalVehicleBuilder: resetPhysicalVehicle - PhysicalVehicle at start: " + physicalVehicle);
        physicalVehicle = new MassPointPhysicalVehicle();
        Log.finest("PhysicalVehicleBuilder: resetPhysicalVehicle - PhysicalVehicle at end: " + physicalVehicle);

        return getInstance();
    }

    /**
     * Function that returns the physicalVehicle that is currently built in the builder class
     *
     * @param controllerBus Optional bus for the controller of the vehicle
     * @param controller Optional controller of the vehicle
     * @param navigation Optional navigation of the vehicle
     * @return PhysicalVehicle that was built with the builder
     */
    public PhysicalVehicle buildPhysicalVehicle(Optional<Bus> controllerBus, Optional<FunctionBlockInterface> controller, Optional<FunctionBlockInterface> navigation) {
        Log.finest("PhysicalVehicleBuilder: buildPhysicalVehicle - PhysicalVehicle at start: " + physicalVehicle);

        physicalVehicle.getSimulationVehicle().setControllerBus(controllerBus);
        physicalVehicle.getSimulationVehicle().setController(controller);
        physicalVehicle.getSimulationVehicle().setNavigation(navigation);

        if(!physicalVehicle.getPhysicalVehicleInitialized()){
            physicalVehicle.initPhysics();
        }
        PhysicalVehicle result = physicalVehicle;
        resetPhysicalVehicle();

        Log.finest("PhysicalVehicleBuilder: buildPhysicalVehicle - Returned physicalVehicle: " + result + " , reset physicalVehicle in builder:" + physicalVehicle);
        return result;
    }

    /**
     * Function that initializes the physicalVehicle that is currently build in the builder class
     *
     * @return PhysicalVehicle that was built with the builder
     */
    public PhysicalVehicleBuilder initPhysicalVehicle() {
        Log.finest("PhysicalVehicleBuilder: initPhysicalVehicle - PhysicalVehicle at start: " + physicalVehicle);
        physicalVehicle.initPhysics();
        Log.finest("PhysicalVehicleBuilder: initPhysicalVehicle - PhysicalVehicle at end: " + physicalVehicle);
        return getInstance();
    }

    /**
     * Method takes a file that has to contain a valid JSON representation of a car.
     * It returns a @{@link PhysicalVehicleBuilder} instance according to the read JSON contents.
     *
     * @param file a file containing a valid JSON config for a car
     * @return {@link PhysicalVehicleBuilder} singleton class
     * @throws IOException thrown if the given file could either not be found or accessed/read.
     */
    public PhysicalVehicleBuilder loadPropertiesFromFile(File file) throws IOException {
        resetPhysicalVehicle();
        String jsonContents = new String(Files.readAllBytes(file.toPath()));
        return loadPropertiesFromJSON(jsonContents);
    }

    /**
     * Method to load car properties from a JSON String instead of manually setting them via the builder.
     * After loading from file, changes are still possible as usual via the methods the builder provides.
     *
     * @param json valid json configuration string
     * @return {@link PhysicalVehicleBuilder} singleton class
     */
    public PhysicalVehicleBuilder loadPropertiesFromJSON(String json) {
        ParsableVehicleProperties data = new Gson().fromJson(json, ParsableVehicleProperties.class); // contains the whole reviews list

        for (VehicleActuator a : data.actuators) {
            physicalVehicle.getSimulationVehicle().setActuatorProperties(a.getActuatorType(), a.getActuatorValueMin(), a.getActuatorValueMax(), a.getActuatorValueChangeRate());
        }

        physicalVehicle.getSimulationVehicle().setWidth(data.width);
        physicalVehicle.getSimulationVehicle().setLength(data.length);
        physicalVehicle.getSimulationVehicle().setHeight(data.height);

        physicalVehicle.getSimulationVehicle().setMassFront(data.massFront);
        physicalVehicle.getSimulationVehicle().setMassBack(data.massBack);
        physicalVehicle.getSimulationVehicle().setWheelRadius(data.wheelRadius);
        physicalVehicle.getSimulationVehicle().setWheelDistLeftRight(data.wheelDistLeftRight);
        physicalVehicle.getSimulationVehicle().setWheelDistFrontBack(data.wheelDistFrontBack);

        initPhysicalVehicle();

        physicalVehicle.setPosition(new ArrayRealVector(new double[]{data.posX, data.posY, data.posZ}));

        Rotation rot = new Rotation(RotationOrder.XYZ, RotationConvention.VECTOR_OPERATOR, data.rotX, data.rotY, data.rotZ);
        RealMatrix rotation = new BlockRealMatrix(rot.getMatrix());
        physicalVehicle.setRotation(rotation);

        return getInstance();
    }

    /**
     * Stores the currently build car JSON serialized in a File on the mass storage.
     * Be careful, default behavior is to overwrite existing files.
     *
     * @param whereToStore file to store the JSON
     * @return current instance of the Builder
     * @throws IOException thrown if the given path cannot be accessed.
     */
    public PhysicalVehicleBuilder storeJSONInFile(File whereToStore) throws IOException {
        //When the car is not initialized it should be because storing the car reads components of massPoint physics
        if (!physicalVehicle.getPhysicalVehicleInitialized()) {
            physicalVehicle.initPhysics();
        }
        Gson g = new Gson();
        PhysicalVehicle v = this.buildPhysicalVehicle(Optional.empty(), Optional.empty(), Optional.empty());
        ParsableVehicleProperties carProps = new PhysicalVehicleBuilder.ParsableVehicleProperties(v);
        String json = g.toJson(carProps, PhysicalVehicleBuilder.ParsableVehicleProperties.class);

        FileWriter fooWriter = new FileWriter(whereToStore, false);

        fooWriter.write(json);
        fooWriter.flush();
        fooWriter.close();

        return getInstance();
    }

    /**
     * Encapsulation class for all file-parsable data concerning a car.
     * Has to be used as a helper object, as plain serialization methods either fail
     * or are not human readable.
     * The values are just a one to one "copy" of the properties configurable in the builder
     * to be able to reuse the building process as is.
     *
     *
     */
    public static class ParsableVehicleProperties {

        private double width;
        private double height;
        private double length;

        private double approxMaxTotalVelocity;

        private double posX;
        private double posY;
        private double posZ;

        private double rotX;
        private double rotY;
        private double rotZ;

        private double massFront;
        private double massBack;
        private double wheelRadius;
        private double wheelDistLeftRight;
        private double wheelDistFrontBack;

        private ArrayList<VehicleActuator> actuators = new ArrayList<>();


        private PhysicalObjectType type;

        public ParsableVehicleProperties(PhysicalVehicle v) {


            width = v.getSimulationVehicle().getWidth();
            height = v.getSimulationVehicle().getHeight();
            length = v.getSimulationVehicle().getLength();

            approxMaxTotalVelocity = v.getSimulationVehicle().getApproxMaxTotalVelocity();

            posX = v.getPosition().getEntry(0);
            posY = v.getPosition().getEntry(1);
            posZ = v.getPosition().getEntry(2);

            massFront = v.getSimulationVehicle().getMassFront();
            massBack = v.getSimulationVehicle().getMassBack();
            wheelRadius = v.getSimulationVehicle().getWheelRadius();

            wheelDistLeftRight = v.getSimulationVehicle().getWheelDistLeftRight();

            wheelDistFrontBack = v.getSimulationVehicle().getWheelDistFrontBack();

            type = v.getPhysicalObjectType();
        }

        public double getWidth() {
            return width;
        }

        public double getHeight() {
            return height;
        }

        public double getLength() {
            return length;
        }

        public double getApproxMaxTotalVelocity() {
            return approxMaxTotalVelocity;
        }

        public double getPosX() {
            return posX;
        }

        public double getPosY() {
            return posY;
        }

        public double getPosZ() {
            return posZ;
        }

        public double getRotX() {
            return rotX;
        }

        public double getRotY() {
            return rotY;
        }

        public double getRotZ() {
            return rotZ;
        }

        public double getMassFront() {
            return massFront;
        }

        public double getMassBack() {
            return massBack;
        }

        public double getWheelRadius() {
            return wheelRadius;
        }

        public double getWheelDistLeftRight() {
            return wheelDistLeftRight;
        }

        public double getWheelDistFrontBack() {
            return wheelDistFrontBack;
        }

        public ArrayList<VehicleActuator> getActuators() {
            return actuators;
        }

        public PhysicalObjectType getType() {
            return type;
        }

        public void setType(PhysicalObjectType type) {
            this.type = type;
        }

    }
}
