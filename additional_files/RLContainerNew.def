Bootstrap: library
From: ubuntu:16.04

%environment
    source /opt/ros/kinetic/setup.sh
    export ROS_PACKAGE_PATH=/opt/ros/kinetic/share
    export CC=/usr/bin/gcc
    export CXX=/usr/bin/g++

%post
    apt-get update -y
    apt-get install -y lsb-release build-essential openjdk-8-jre gcc make cmake git python2.7 python-dev python-numpy swig libboost-all-dev curl
    apt-get install -y openjdk-8-jdk maven ninja-build ccache libopenblas-dev libblas-dev liblapack-dev libopencv-dev libarmadillo-dev
    apt-get install -y python-tk python3 python3-pip libboost-all-dev wget unzip

    update-alternatives --config java
    
    pip3 install --upgrade "cmake>=3.13.2"

    wget https://bootstrap.pypa.io/pip/2.7/get-pip.py
    python get-pip.py
    pip install pyprind h5py matplotlib numpy==1.16.5 mxnet==1.5.1.post0

    pip install mxnet
    git clone --recursive https://github.com/apache/incubator-mxnet.git mxnet
    cd mxnet && git checkout tags/1.5.0 && git submodule update --recursive --init
    mkdir build && cd build && cmake -DUSE_CPP_PACKAGE=1 -DUSE_CUDA=0 -GNinja .. && ninja -v
    cd .. && cp -r include/mxnet ../usr/include/mxnet && cp -r cpp-package/include/mxnet-cpp ../usr/include && cp -r 3rdparty/tvm/nnvm/include/nnvm ../usr/include && cp -r 3rdparty/dmlc-core/include/dmlc ../usr/include

    cd ../usr/lib && cp -r ../../mxnet/build/libmxnet.so . && cd ../..

    wget http://sourceforge.net/projects/arma/files/armadillo-9.900.5.tar.xz && tar -xf armadillo-9.900.5.tar && cd armadillo-9.900.5 && cmake . && make && make install && cd ..
    
    mkdir -p .config/matplotlib
    echo "backend : Agg" > .config/matplotlib/matplotlibrc

    sh -c 'echo "deb http://packages.ros.org/ros/ubuntu $(lsb_release -sc) main" > /etc/apt/sources.list.d/ros-latest.list'

    curl -s https://raw.githubusercontent.com/ros/rosdistro/master/ros.asc | apt-key add

    apt-get update -y

    apt-get install -y ros-kinetic-desktop

    apt install -y python-rosdep python-rosinstall python-rosinstall-generator python-wstool build-essential

    rosdep init
    rosdep update
    rm /opt/ros/kinetic/etc/catkin/profile.d/1.ros_package_path.sh
    rm /opt/ros/kinetic/etc/catkin/profile.d/99.roslisp.sh
